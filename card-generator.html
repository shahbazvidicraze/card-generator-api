<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Card Generator</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #2c2c3e; color: #f0f0f0; padding-top: 20px; font-family: sans-serif;
        }
        .form-section, .display-section {
            background-color: #3a3a50; padding: 20px; border-radius: 8px; margin-bottom: 20px;
        }
        .form-control, .custom-select {
            background-color: #4a4a63; color: #f0f0f0; border: 1px solid #5a5a76;
        }
        .form-control::placeholder { color: #a0a0b8; }
        .form-control:focus, .custom-select:focus {
            background-color: #50506a; color: #f0f0f0; border-color: #7a7ab0; box-shadow: none;
        }
        .btn-primary { background-color: #7a7ab0; border-color: #7a7ab0; width: 100%; }
        .btn-primary:hover { background-color: #686898; border-color: #686898; }
        .btn-primary:disabled { background-color: #5a5a76; border-color: #5a5a76; }

        .theme-selector { display: flex; flex-wrap: wrap; }
        .theme-selector img, .theme-selector .upload-theme-option {
            width: 80px; height: 100px; object-fit: cover; border: 3px solid transparent;
            border-radius: 5px; cursor: pointer; margin-right: 10px; margin-bottom: 10px;
            transition: border-color 0.2s ease-in-out, transform 0.2s ease-in-out;
        }
        .theme-selector img:hover, .theme-selector .upload-theme-option:hover { transform: scale(1.05); }
        .theme-selector img.selected, .theme-selector .upload-theme-option.selected { border-color: #a0a0ff; box-shadow: 0 0 8px #a0a0ff; }
        
        .theme-selector .upload-theme-option {
            display: flex; align-items: center; justify-content: center; flex-direction: column;
            background-color: #5a5a76; color: #c0c0d8; font-size: 2em; border-style: dashed; border-color: #7a7ab0;
        }
        .theme-selector .upload-theme-option span { font-size: 0.3em; margin-top: 5px; }
        
        .card-color-theme .color-dot {
            width: 30px; height: 30px; border-radius: 50%; border: 2px solid #6c6c85;
            cursor: pointer; margin-right: 5px; display: inline-block;
            transition: box-shadow 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }
        .card-color-theme .color-dot.selected { border-color: #fff; box-shadow: 0 0 0 3px #a0a0ff; }
        
        /* Card Preview Styling */
        .card-preview-base { /* Common for main and thumb content */
            border: 1px solid #5a5a76;
            background-color: #fff; position: relative; overflow: hidden; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        #cardPreviewContainer { /* Main large preview */
            width: 315px; height: 440px; /* Default, updated by JS */
            margin: 20px auto; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            transition: width 0.3s ease-in-out, height 0.3s ease-in-out;
        }
        #deckThumbnailsContainer { 
            display: flex; /* Use flexbox for horizontal layout */
            flex-wrap: nowrap; /* Prevent wrapping to new line by default */
            overflow-x: auto; /* Allow horizontal scrolling if many thumbs */
            padding: 10px 0; 
            justify-content: flex-start; /* Align thumbs to the start */
        }
        .card-preview-thumbnail-wrapper { 
            flex-shrink: 0; /* Prevent thumbnails from shrinking */
            margin: 0 5px; /* Spacing between thumbnails */
            cursor: pointer;
            border: 3px solid transparent; 
            border-radius: 5px; 
            padding: 2px; 
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
         .card-preview-thumbnail-wrapper.selected-thumb  > .card-preview-base {
            border-color: #a0a0ff !important; /* Highlight color for selected thumbnail */
            box-shadow: 0 0 10px #a0a0ff !important;
            padding: 1px;
        }
        .card-preview-thumbnail-wrapper .card-preview-base { /* Thumbnail content itself */
             margin: 0; /* Reset margin for the inner div */
             width: 70px; /* Fixed width for thumbnail card content */
             height: 98px; /* Fixed height for thumbnail (maintaining ~Poker aspect ratio) */
        }

        .card-element { position: absolute; box-sizing: border-box; }
        .card-element.image { background-size: cover; background-position: center; }
        .card-element.text {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 2px; /* Reduced padding for thumbnails */
            overflow-wrap: break-word; word-wrap: break-word;
            white-space: pre-wrap; overflow-y: hidden; /* Hide scroll on thumbs, main can have auto */
        }
        label { margin-bottom: .3rem; font-size: 0.9em; }
        .small-label { font-size: 0.8em; color: #c0c0d8; }
        #loadingIndicator { display: none; text-align: center; margin-top: 15px; }
        .form-group { margin-bottom: 0.8rem; }
        h3, h5, h6 { font-weight: 300; }
    </style>
</head>
<body>
    <div class="container-fluid">
        <h3 class="text-center mb-4">Create your Card Design</h3>
        <div class="row">
            <div class="col-lg-5 col-md-12">
                <div class="form-section">
                    <form id="cardGenerationForm">
                        <!-- AI Prompt -->
                        <div class="form-group">
                            <label for="aiPrompt">AI Prompt (Describe card content)</label>
                            <textarea class="form-control" id="aiPrompt" rows="3" placeholder="e.g., Mathematics learning game">Mathematics learning game for school children</textarea>
                        </div>
                        <!-- Genres & Card Size -->
                        <div class="row">
                            <div class="form-group col-md-6"><label for="genres">Genres (for AI)</label><select class="custom-select" id="genres"><option selected value="Educational">Educational</option><option value="Fantasy">Fantasy</option></select></div>
                            <div class="form-group col-md-6"><label for="cardSize">Card size</label>
                                <select class="custom-select" id="cardSize">
                                    <option value="63x88" data-width="315" data-height="440" selected>Poker (63x88mm)</option>
                                    <option value="57x89" data-width="285" data-height="445">Bridge (57x89mm)</option>
                                    <option value="70x120" data-width="350" data-height="600">Tarot (70x120mm)</option>
                                    <option value="custom">Custom Pixels</option>
                            </select>
                        </div>
                        </div>
                        <!-- Custom Dimensions -->
                         <div class="row" id="customDimensionsRow" style="display: none;">
                            <div class="form-group col-md-6"><label for="cardWidthPx">Card Width (px)</label><input type="number" class="form-control" id="cardWidthPx" value="315"></div>
                            <div class="form-group col-md-6"><label for="cardHeightPx">Card Height (px)</label><input type="number" class="form-control" id="cardHeightPx" value="440"></div>
                        </div>
                        <!-- Number of Cards -->
                        <div class="form-group">
                            <label for="numCardsInDeck">How many Cards per Deck</label>
                            <select class="custom-select" id="numCardsInDeck">
                                <option value="1">1</option><option value="3">3</option><option value="5" selected>5</option><option value="10">10</option>
                            </select>
                        </div>
                        <!-- Theme Selector -->
                        <div class="form-group">
                            <label>Theme (Select or Upload for Background)</label>
                            <div class="theme-selector" id="themeSelectorContainer">
                                <div class="upload-theme-option" id="uploadThemeBtn" title="Upload Custom Image">+<span>Upload</span></div>
                                <input type="file" id="customImageUpload" accept="image/*" style="display: none;">
                            </div>
                        </div>
                        <!-- Image Usage Preference -->
                        <div class="form-group">
                            <label for="imageUsagePreference">Background Image Preference</label>
                            <select class="custom-select" id="imageUsagePreference">
                                <option value="ai_only_white_fallback">AI Image (placeholder on fail)</option>
                                <option value="ai_then_selected_theme" selected>AI Image (use selected Theme on AI fail)</option>
                                <option value="selected_theme_only">Use Selected Theme Image Only</option>
                            </select>
                        </div>
                        <!-- Accent Color -->
                        <div class="form-group">
                            <label>Accent Color (for text & AI image)</label>
                            <div class="card-color-theme">
                                <span class="color-dot" style="background-color: #FF6347;" data-color-prompt="tomato red accent" data-color-value="#333333"></span>
                                <span class="color-dot selected" style="background-color: #4682B4;" data-color-prompt="steel blue accent" data-color-value="#4682B4"></span>
                                <span class="color-dot" style="background-color: #FFD700;" data-color-prompt="gold accent" data-color-value="#FFD700"></span>
                                <span class="color-dot" style="background-color: #90EE90;" data-color-prompt="light green accent" data-color-value="#90EE90"></span>
                                <span class="color-dot" style="background-color: #FFB6C1;" data-color-prompt="light pink accent" data-color-value="#FFB6C1"></span>
                                <span class="color-dot" style="background-color: #FFFFFF;" data-color-prompt="white accent" data-color-value="#FFFFFF"></span>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary mt-3" id="generateCardButton">Create Card Design</button>
                        <div id="loadingIndicator" class="mt-3"><div class="spinner-border text-light" role="status"><span class="sr-only">Loading...</span></div></div>
                        <div id="errorMessage" class="alert alert-danger mt-3" style="display: none;"></div>
                    </form>
                </div>
            </div>
            <div class="col-lg-7 col-md-12">
                <div class="display-section">
                    <h5 class="text-center">Generated Card Version</h5>
                    <div id="cardPreviewContainer" class="card-preview-base"></div>
                    <p class="text-center small-label mt-2">Click thumbnails to view in large preview.</p>
                    <div id="deckThumbnailsContainerWrapper" class="mt-4" style="display:none;">
                        <h6 class="text-center">Deck Previews</h6>
                        <div id="deckThumbnailsContainer">
                            <!-- Thumbnails will be injected here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script>
        const PREDEFINED_THEMES = [
            { name: "Abstract Flow", prompt: "abstract flowing colors", src: "https://i.pinimg.com/736x/c6/2a/3e/c62a3e65a0c8c38ef695144b447cd7dc.jpg" },
            { name: "Geometric Patterns", prompt: "geometric patterns", src: "https://i.pinimg.com/736x/b5/1c/99/b51c99f3d03d029d1dea464b89b4329c.jpg" },
            { name: "Bubble Border", prompt: "educational bubble border", src: "https://image.slidesdocs.com/responsive-images/docs/stationery-for-education-in-a-bubble-page-border-background-word-template_3737a7d4a6__1131_1600.jpg" },
            { name: "Green Math", prompt: "green math theme", src: "https://image.slidesdocs.com/responsive-images/docs/simplifying-math-with-a-touch-of-green-page-border-background-word-template_3241e560c8__1131_1600.jpg" },
            { name: "Pencil Art", prompt: "pencil and paper art", src: "https://clipart-library.com/images/pi7r57ndT.jpg" },
            { name: "Fantasy Landscape", prompt: "fantasy landscape", src: "https://i.pinimg.com/736x/bb/94/11/bb94116a9f46a6e4a54533f082bf4cfb.jpg" },
            { name: "Chalkboard", prompt: "school chalkboard background", src: "https://wallpapers.com/images/hd/school-picture-background-3w7ny3s5pak6kw2l.jpg" }
        ];
       let uploadedImageBase64 = null;
        let currentSelectedThemeSrc = null; 
        let dataCache = {
            fullDeckData: [], imageWasAIgenerated: false,
            originalCardWidth: 315, originalCardHeight: 440,
            themeSrcSelectedAtGeneration: null
        };
        const DEFAULT_FRONTEND_PLACEHOLDER_URL = "https://via.placeholder.com/150x200.png?text=No+Theme";

        $(document).ready(function() {
            const $themeSelectorContainer = $('#themeSelectorContainer');
            // Populate predefined themes (Upload button is already in HTML)
            PREDEFINED_THEMES.forEach((theme, index) => {
                const $img = $('<img>')
                    .attr('src', theme.src)
                    .attr('alt', theme.name)
                    .data('theme-prompt', theme.prompt + " style") // For AI image gen
                    .data('theme-src', theme.src)        // Actual src for fallback
                    .data('is-predefined', true);
                if (index === 0) { // Select the first predefined theme by default
                    $img.addClass('selected');
                    currentSelectedThemeSrc = theme.src;
                }
                // Prepend to keep upload button visually last if it was hardcoded, or append before it
                $('#uploadThemeBtn').before($img);
            });

            $themeSelectorContainer.on('click', 'img, .upload-theme-option', function() {
                $themeSelectorContainer.find('img, .upload-theme-option').removeClass('selected');
                $(this).addClass('selected');

                if ($(this).is('img') && $(this).data('is-predefined')) {
                    currentSelectedThemeSrc = $(this).data('theme-src');
                    uploadedImageBase64 = null;
                    $('#uploadThemeBtn').html('+<span>Upload</span>').removeClass('selected-uploaded'); // Reset upload button
                } else if ($(this).is('.upload-theme-option')) {
                    if (uploadedImageBase64) { // If re-clicking upload btn after an upload
                        currentSelectedThemeSrc = uploadedImageBase64;
                    } else { // Clicking upload btn to trigger file input
                         $('#customImageUpload').val(null).click(); // Reset and click
                    }
                }
            });
            
            $('#customImageUpload').on('change', function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        uploadedImageBase64 = e.target.result;
                        currentSelectedThemeSrc = uploadedImageBase64;
                        $('#uploadThemeBtn').html(`<img src="${uploadedImageBase64}" style="width:100%; height:100%; object-fit:cover;" alt="Uploaded">`).addClass('selected-uploaded');
                        $themeSelectorContainer.find('img').removeClass('selected'); // Deselect predefined
                        $('#uploadThemeBtn').addClass('selected');
                    }
                    reader.readAsDataURL(file);
                }
            });

            $('.card-color-theme .color-dot').on('click', function() {
                $('.card-color-theme .color-dot').removeClass('selected');
                $(this).addClass('selected');
            });

            $('#cardSize').on('change', function() {
                const selectedVal = $(this).val();
                if (selectedVal === 'custom') {
                    $('#customDimensionsRow').slideDown();
                } else {
                    $('#customDimensionsRow').slideUp();
                    const selectedOption = $(this).find('option:selected');
                    $('#cardWidthPx').val(selectedOption.data('width'));
                    $('#cardHeightPx').val(selectedOption.data('height'));
                }
                updatePreviewContainerDimensions();
            }).trigger('change');

            $('#cardWidthPx, #cardHeightPx').on('input', function() {
                if ($('#cardSize').val() === 'custom') {
                    updatePreviewContainerDimensions();
                }
            });

            function updatePreviewContainerDimensions() {
                let currentCardWidth = parseInt($('#cardWidthPx').val()) || 315;
                let currentCardHeight = parseInt($('#cardHeightPx').val()) || 440;
                let displayWidth = currentCardWidth;
                let displayHeight = currentCardHeight;

                const parentWidth = $('.display-section').width();
                const maxWidth = Math.min(450, parentWidth ? parentWidth - 40 : 450);
                if (displayWidth > maxWidth && maxWidth > 0) {
                    const scale = maxWidth / displayWidth;
                    displayWidth = maxWidth;
                    displayHeight = Math.round(displayHeight * scale);
                }
                $('#cardPreviewContainer').css({ width: displayWidth + 'px', height: displayHeight + 'px' });
            }
            updatePreviewContainerDimensions();
            $(window).on('resize', updatePreviewContainerDimensions);


             $('#cardGenerationForm').on('submit', async function(e) {
                e.preventDefault();
                const $generateButton = $('#generateCardButton'); /* ... (disable button, show loading) ... */
                $('#errorMessage').hide().text('');
                $('#cardPreviewContainer').empty().css('background-image', 'none');
                $('#deckThumbnailsContainer').empty(); 
                $('#deckThumbnailsContainerWrapper').hide();


                const aiPromptText = $('#aiPrompt').val();
                const genre = $('#genres').val();
                const themePromptForAI = $('#themeSelectorContainer .selected').data('theme-prompt') || "";
                // currentSelectedThemeSrc is already updated globally

                const actualTextColor = $('.card-color-theme .color-dot.selected').data('color-value') || "#333333";
                
                let cardWidth, cardHeight;
                const cardSizeSelection = $('#cardSize').val();
                if (cardSizeSelection === 'custom') {
                    cardWidth = parseInt($('#cardWidthPx').val());
                    cardHeight = parseInt($('#cardHeightPx').val());
                } else {
                    cardWidth = parseInt($('#cardSize option:selected').data('width'));
                    cardHeight = parseInt($('#cardSize option:selected').data('height'));
                }

                if (!aiPromptText.trim()) { /* ... validation ... */ return; }
                if (!cardWidth || !cardHeight || cardWidth <= 0 || cardHeight <= 0) { /* ... validation ... */ return; }

                let fullUserPrompt = aiPromptText;
                if (genre && genre.toLowerCase() !== "none" && genre !== "") { fullUserPrompt += `, ${genre} genre`; }
                const imageUsagePref = $('#imageUsagePreference').val();
                if (imageUsagePref !== 'selected_theme_only' && themePromptForAI) {
                    fullUserPrompt += `, ${themePromptForAI}`;
                }
                const colorPrompt = $('.card-color-theme .color-dot.selected').data('color-prompt') || "";
                if (colorPrompt) { fullUserPrompt += `, with ${colorPrompt}`; }

                const numCards = parseInt($('#numCardsInDeck').val()) || 1;
                
                const payload = {
                    userPrompt: fullUserPrompt,
                    cardName: "GenDeck-" + aiPromptText.substring(0,10).replace(/\s/g,'_'),
                    cardWidthPx: cardWidth, cardHeightPx: cardHeight,
                    imageOutputFormat: "png", numCardsInDeck: numCards,
                    defaultTextColor: actualTextColor
                };
                console.log("Sending payload:", payload);

                try {
                    const response = await fetch('http://localhost:5001/api/cards/generate-full-card', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                    });
                    const backendResponseData = await response.json();
                    $generateButton.prop('disabled', false).text('Create Card Design');
                    $('#loadingIndicator').hide();

                    if (response.ok && backendResponseData.cards && backendResponseData.cards.length > 0) {
                        console.log("Deck received:", backendResponseData);
                        dataCache.imageWasAIgenerated = backendResponseData.imageWasAIgenerated;
                        dataCache.originalCardWidth = cardWidth; 
                        dataCache.originalCardHeight = cardHeight;
                        dataCache.fullDeckData = JSON.parse(JSON.stringify(backendResponseData.cards));
                        dataCache.themeSrcSelectedAtGeneration = currentSelectedThemeSrc;

                        const imageUsagePref = $('#imageUsagePreference').val();
                        
                        const processedCardsToRender = dataCache.fullDeckData.map((originalCardData) => {
                            let cardToDisplay = JSON.parse(JSON.stringify(originalCardData));
                            let finalImgUrlForCard;
                            const aiActuallySucceeded = dataCache.imageWasAIgenerated;

                            if (imageUsagePref === 'selected_theme_only') {
                                finalImgUrlForCard = dataCache.themeSrcSelectedAtGeneration || DEFAULT_FRONTEND_PLACEHOLDER_URL;
                            } else if (imageUsagePref === 'ai_then_selected_theme') {
                                finalImgUrlForCard = aiActuallySucceeded ? 
                                    cardToDisplay.elements.find(el=>el.type==='image' && el.zIndex===0)?.imageUrl : 
                                    (dataCache.themeSrcSelectedAtGeneration || DEFAULT_FRONTEND_PLACEHOLDER_URL);
                            } else { 
                                finalImgUrlForCard = cardToDisplay.elements.find(el=>el.type==='image' && el.zIndex===0)?.imageUrl;
                            }

                            if (!cardToDisplay.elements) cardToDisplay.elements = [];
                            let imgElement = cardToDisplay.elements.find(el => el.type === 'image' && el.zIndex === 0);
                            if (imgElement) {
                                imgElement.imageUrl = finalImgUrlForCard;
                            } else {
                                cardToDisplay.elements.unshift({
                                    elementId: 'img-elem-fallback-' + Date.now(), type: 'image', imageUrl: finalImgUrlForCard,
                                    x: 0, y: 0, width: cardToDisplay.widthPx, height: cardToDisplay.heightPx, zIndex: 0, rotation: 0
                                });
                                cardToDisplay.elements.sort((a,b) => (a.zIndex||0)-(b.zIndex||0));
                            }
                            return cardToDisplay;
                        });

                        if (processedCardsToRender.length > 0) {
                            renderCard(processedCardsToRender[0], cardWidth, cardHeight, $('#cardPreviewContainer'), false, processedCardsToRender);
                            // Select the first thumbnail by default if deck exists
                            $('#deckThumbnailsContainerWrapper .card-preview-thumbnail-wrapper').first().addClass('selected-thumb');
                        }
                        
                        if (processedCardsToRender.length > 0) { // Changed from >1 to >0 to show thumbs even for 1 card
                            const $thumbnailsContainer = $('#deckThumbnailsContainer');
                            $thumbnailsContainer.empty(); // Clear before adding new ones
                            $('#deckThumbnailsContainerWrapper').show().find('h6').show();

                            processedCardsToRender.forEach((cardInst, idx) => {
                                renderThumbnail(cardInst, cardWidth, cardHeight, idx, $thumbnailsContainer, processedCardsToRender);
                            });
                        }
                    } else {
                        $('#errorMessage').text(data.message || 'Error generating card. Details: ' + (data.details || JSON.stringify(data.error) || 'Unknown error')).show();
                    }
                } catch (error) {
                    $('#loadingIndicator').hide();
                    $generateButton.prop('disabled', false).text('Create Card Design');
                    $('#errorMessage').text('Network error or server unavailable: ' + error.message).show();
                    console.error("Fetch error:", error);
                }
            });

            function renderCard(cardData, baseCardWidth, baseCardHeight, $container, isThumbnail = false, fullDeckContext = null) {
                $container.empty(); // Clear content of the specific container ($cardPreviewContainer or a thumbnail's content div)
                
                let displayWidth, displayHeight;
                const parentWidth = $container.parent().width(); // Get width of immediate parent for scaling context

                if (isThumbnail) {
                    displayWidth = parseInt($container.parent().css('width')) || 70; // Use wrapper's target width
                    displayHeight = parseInt($container.parent().css('height')) || 98; // Use wrapper's target height
                } else { // Main preview
                    displayWidth = baseCardWidth;
                    displayHeight = baseCardHeight;
                    const maxDisplayWidth = Math.min(450, parentWidth ? parentWidth - 40 : 450);
                    if (baseCardWidth > maxDisplayWidth && maxDisplayWidth > 0) {
                        const scale = maxDisplayWidth / baseCardWidth;
                        displayWidth = maxDisplayWidth;
                        displayHeight = Math.round(baseCardHeight * scale);
                    }
                }
                
                $container.css({ // Apply to the direct container (.card-preview-base)
                    width: displayWidth + 'px', height: displayHeight + 'px',
                    backgroundColor: cardData.metadata?.backgroundColor || '#fff',
                    // Border and margin are handled by wrapper for thumbnails
                    border: $container.hasClass('card-preview-thumbnail-content') ? '1px solid #777' : '1px solid #5a5a76', // Check class
                    margin: $container.hasClass('card-preview-thumbnail-content') ? '0' : '20px auto',
                    position: 'relative', overflow: 'hidden',
                    boxShadow: $container.hasClass('card-preview-thumbnail-content') ? '0 1px 2px rgba(0,0,0,0.2)' : '0 4px 8px rgba(0,0,0,0.3)',
                });

                // Click handler is now on the WRAPPER for thumbnails, not the content div
                if (cardData.elements && Array.isArray(cardData.elements)) {
                    const sortedElements = [...cardData.elements].sort((a, b) => (a.zIndex || 0) - (b.zIndex || 0));
                    renderElementsToContainer(sortedElements, $container, displayWidth, displayHeight, baseCardWidth, baseCardHeight, isThumbnail);
                }
            }

            function renderThumbnail(cardData, originalCardWidth, originalCardHeight, index, $deckThumbsContainer, fullDeckContext) {
                const $thumbWrapper = $('<div></div>')
                    .addClass('card-preview-thumbnail-wrapper')
                    .data('card-id', cardData._id || 'index-' + index);

                const $thumbContentDiv = $('<div></div>')
                    .addClass('card-preview-base card-preview-thumbnail-content') // For styling
                    .attr('id', 'thumb-content-' + (cardData._id || index));
                
                $thumbWrapper.append($thumbContentDiv);
                $deckThumbsContainer.append($thumbWrapper);

                // Set fixed size for the wrapper (which determines click area and border)
                $thumbWrapper.css({ width: '76px', height: '104px' }); // 70x98 content + 3px border + 2px padding

                // Render the card content inside the $thumbContentDiv
                renderCard(cardData, originalCardWidth, originalCardHeight, $thumbContentDiv, true, fullDeckContext);

                // Attach click handler to the wrapper
                $thumbWrapper.off('click').on('click', function() { 
                    const clickedCardId = $(this).data('card-id');
                    const originalCardFromCache = dataCache.fullDeckData.find(
                        c => (c._id || 'index-' + fullDeckContext.indexOf(c)) === clickedCardId
                    ) || cardData; // Fallback, though find should work

                    let cardToDisplayInMain = JSON.parse(JSON.stringify(originalCardFromCache));
                    
                    const imageUsagePrefOnClick = $('#imageUsagePreference').val();
                    const aiSucceededOnClick = dataCache.imageWasAIgenerated;
                    const themeSrcForFallbackOnClick = dataCache.themeSrcSelectedAtGeneration; 

                    let finalImageForMainDisplay;
                    if (imageUsagePrefOnClick === 'selected_theme_only') {
                        finalImageForMainDisplay = themeSrcForFallbackOnClick || DEFAULT_FRONTEND_PLACEHOLDER_URL;
                    } else if (imageUsagePrefOnClick === 'ai_then_selected_theme') {
                        finalImageForMainDisplay = aiSucceededOnClick ? 
                            cardToDisplayInMain.elements.find(el=>el.type==='image' && el.zIndex===0)?.imageUrl : 
                            (themeSrcForFallbackOnClick || DEFAULT_FRONTEND_PLACEHOLDER_URL);
                    } else { // ai_only_white_fallback
                         finalImageForMainDisplay = cardToDisplayInMain.elements.find(el=>el.type==='image' && el.zIndex===0)?.imageUrl;
                    }
                    
                    if (!cardToDisplayInMain.elements) cardToDisplayInMain.elements = [];
                    let imageElement = cardToDisplayInMain.elements.find(el => el.type === 'image' && el.zIndex === 0);
                    if(imageElement) {
                        imageElement.imageUrl = finalImageForMainDisplay;
                    } else { 
                        cardToDisplayInMain.elements.unshift({
                            elementId: 'mainfb-' + Date.now(), type: 'image', imageUrl: finalImageForMainDisplay,
                            x:0, y:0, width: cardToDisplayInMain.widthPx, height: cardToDisplayInMain.heightPx,
                            zIndex:0, rotation:0
                        });
                        cardToDisplayInMain.elements.sort((a,b)=>(a.zIndex||0)-(b.zIndex||0));
                    }
                    
                    renderCard(cardToDisplayInMain, dataCache.originalCardWidth, dataCache.originalCardHeight, $('#cardPreviewContainer'), false, fullDeckContext);
                    $('#deckThumbnailsContainer .card-preview-thumbnail-wrapper').removeClass('selected-thumb');
                    $(this).addClass('selected-thumb');
                });
            }
            
            function renderElementsToContainer(elements, $container, displayWidth, displayHeight, cardActualWidth, cardActualHeight, isThumbnailFlag) {
                elements.forEach(element => {
                    const $el = $('<div></div>').addClass('card-element').addClass(element.type);
                    
                    const scaleX = (cardActualWidth === 0) ? 1 : displayWidth / cardActualWidth;
                    const scaleY = (cardActualHeight === 0) ? 1 : displayHeight / cardActualHeight;

                    $el.css({
                        left: (element.x || 0) * scaleX + 'px',
                        top: (element.y || 0) * scaleY + 'px',
                        width: (element.width || 100) * scaleX + 'px',
                        height: (element.height || 50) * scaleY + 'px',
                        zIndex: element.zIndex || 0,
                        transform: `rotate(${element.rotation || 0}deg)`
                    });

                    if (element.type === 'image' && element.imageUrl) {
                        $el.css('background-image', `url(${element.imageUrl})`);
                    } else if (element.type === 'text') {
                        let textContent = element.content || '';
                        textContent = textContent.replace(/\r\n/g, '<br>').replace(/\n/g, '<br>');
                        $el.html(textContent);
                        
                        const originalFontSize = parseFloat(element.fontSize || '22px');
                        const fontScale = Math.min(scaleX, scaleY); 
                        // More nuanced font scaling for thumbnails vs main card
                        let scaledFontSize;
                        if (isThumbnailFlag) {
                            scaledFontSize = Math.max(6, originalFontSize * fontScale * 0.8); // Smaller for thumbs
                        } else {
                            scaledFontSize = Math.max(10, originalFontSize * fontScale);
                        }
                        // Prevent overly large fonts if scaling up significantly
                        scaledFontSize = Math.min(scaledFontSize, originalFontSize * 1.5);


                        $el.css({
                            fontSize: scaledFontSize + 'px',
                            fontFamily: element.fontFamily || 'Arial',
                            color: element.color || '#333333',
                            textAlign: element.textAlign || 'center',
                            fontWeight: element.fontWeight || 'normal',
                            fontStyle: element.fontStyle || 'normal',
                        });
                    }
                    $container.append($el);
                });
            }
        });
    </script>
</body>
</html>