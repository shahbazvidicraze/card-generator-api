<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Card Generator</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #2c2c3e; color: #f0f0f0; padding-top: 20px; font-family: sans-serif;
        }
        .form-section, .display-section {
            background-color: #3a3a50; padding: 20px; border-radius: 8px; margin-bottom: 20px;
        }
        .form-control, .custom-select {
            background-color: #4a4a63; color: #f0f0f0; border: 1px solid #5a5a76;
        }
        .form-control::placeholder { color: #a0a0b8; }
        .form-control:focus, .custom-select:focus {
            background-color: #50506a; color: #f0f0f0; border-color: #7a7ab0; box-shadow: none;
        }
        .btn-primary { background-color: #7a7ab0; border-color: #7a7ab0; width: 100%; }
        .btn-primary:hover { background-color: #686898; border-color: #686898; }
        .btn-primary:disabled { background-color: #5a5a76; border-color: #5a5a76; }

        .theme-selector { display: flex; flex-wrap: wrap; }
        .theme-selector img {
            width: 80px; height: 100px; object-fit: cover; border: 3px solid transparent;
            border-radius: 5px; cursor: pointer; margin-right: 10px; margin-bottom: 10px;
            transition: border-color 0.2s ease-in-out, transform 0.2s ease-in-out;
        }
        .theme-selector img:hover { transform: scale(1.05); }
        .theme-selector img.selected { border-color: #a0a0ff; box-shadow: 0 0 8px #a0a0ff; }
        .card-color-theme .color-dot {
            width: 30px; height: 30px; border-radius: 50%; border: 2px solid #6c6c85;
            cursor: pointer; margin-right: 5px; display: inline-block;
            transition: box-shadow 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }
        .card-color-theme .color-dot.selected { border-color: #fff; box-shadow: 0 0 0 3px #a0a0ff; }
        .card-preview-container {
            width: 315px; height: 440px; margin: 20px auto; border: 1px solid #5a5a76;
            background-color: #fff; position: relative; overflow: hidden; box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            transition: width 0.3s ease-in-out, height 0.3s ease-in-out; /* Smooth transition for size changes */
        }
        .card-element { position: absolute; box-sizing: border-box; }
        .card-element.image { background-size: cover; background-position: center; }
        .card-element.text {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 5px; overflow-wrap: break-word; word-wrap: break-word;
            white-space: pre-wrap; overflow-y: auto;
        }
        label { margin-bottom: .3rem; font-size: 0.9em; }
        .small-label { font-size: 0.8em; color: #c0c0d8; }
        #loadingIndicator { display: none; text-align: center; margin-top: 15px; }
        .form-group { margin-bottom: 0.8rem; }
        h3, h5, h6 { font-weight: 300; }
    </style>
</head>
<body>
    <div class="container-fluid">
        <h3 class="text-center mb-4">Create your Card Design</h3>
        <div class="row">
            <div class="col-lg-5 col-md-12">
                <div class="form-section">
                    <form id="cardGenerationForm">
                        <div class="form-group">
                            <label for="aiPrompt">AI Prompt (Describe card content)</label>
                            <textarea class="form-control" id="aiPrompt" rows="3" placeholder="e.g., Mathematics learning game for school children"></textarea>
                        </div>

                        <div class="row">
                            <div class="form-group col-md-6">
                                <label for="genres">Genres (for AI)</label>
                                <select class="custom-select" id="genres">
                                    <option selected value="Educational">Educational</option>
                                    <option value="Fantasy">Fantasy</option>
                                    <option value="SciFi">Sci-Fi</option>
                                    <option value="Historical">Historical</option>
                                    <option value="Abstract">Abstract</option>
                                    <option value="Modern">Modern</option>
                                </select>
                            </div>
                            <div class="form-group col-md-6">
                                <label for="cardSize">Card size</label>
                                <select class="custom-select" id="cardSize">
                                    <option value="63x88" data-width="315" data-height="440" selected>Poker (63x88mm)</option>
                                    <option value="57x89" data-width="285" data-height="445">Bridge (57x89mm)</option>
                                    <option value="70x120" data-width="350" data-height="600">Tarot (70x120mm)</option>
                                    <option value="custom">Custom Pixels</option>
                                </select>
                            </div>
                        </div>
                         <div class="row" id="customDimensionsRow" style="display: none;">
                            <div class="form-group col-md-6">
                                <label for="cardWidthPx">Card Width (px)</label>
                                <input type="number" class="form-control" id="cardWidthPx" value="315">
                            </div>
                            <div class="form-group col-md-6">
                                <label for="cardHeightPx">Card Height (px)</label>
                                <input type="number" class="form-control" id="cardHeightPx" value="440">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="numCards">Number of Text Items</label>
                            <select class="custom-select" id="numCards">
                                <option value="1">1</option>
                                <option value="3">3</option>
                                <option value="5" selected>5</option>
                                <option value="10">10</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Theme (Select a style for AI or as fallback)</label>
                            <div class="theme-selector" id="themeSelectorContainer">
                                <!-- Images will be dynamically inserted here by JavaScript -->
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Accent Color (for text & AI image)</label>
                            <div class="card-color-theme">
                                <span class="color-dot selected" style="background-color: #FF6347;" data-color-prompt="tomato red accent" data-color-value="#333333"></span>
                                <span class="color-dot" style="background-color: #4682B4;" data-color-prompt="steel blue accent" data-color-value="#4682B4"></span>
                                <span class="color-dot" style="background-color: #FFD700;" data-color-prompt="gold accent" data-color-value="#FFD700"></span>
                                <span class="color-dot" style="background-color: #90EE90;" data-color-prompt="light green accent" data-color-value="#90EE90"></span>
                                <span class="color-dot" style="background-color: #FFB6C1;" data-color-prompt="light pink accent" data-color-value="#FFB6C1"></span>
                                <span class="color-dot" style="background-color: #FFFFFF;" data-color-prompt="white accent" data-color-value="#FFFFFF"></span>
                            </div>
                        </div>
                        
                        <div class="form-group form-check">
                            <input type="checkbox" class="form-check-input" id="useSelectedThemeOnAIFail">
                            <label class="form-check-label small-label" for="useSelectedThemeOnAIFail">Use selected Theme image if AI image generation fails</label>
                        </div>

                        <button type="submit" class="btn btn-primary mt-3" id="generateCardButton">Create Card Design</button>
                        <div id="loadingIndicator" class="mt-3"><div class="spinner-border text-light" role="status"><span class="sr-only">Loading...</span></div></div>
                        <div id="errorMessage" class="alert alert-danger mt-3" style="display: none;"></div>
                    </form>
                </div>
            </div>

            <div class="col-lg-7 col-md-12">
                <div class="display-section">
                    <h5 class="text-center">Generated Card Version</h5>
                    <div id="cardPreviewContainer" class="card-preview-container"></div>
                    <p class="text-center small-label mt-2">This is a dynamic preview.</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script>
        const PREDEFINED_THEMES = [ // Renamed for clarity
            { name: "Abstract Flow", prompt: "abstract flowing colors", src: "https://i.pinimg.com/736x/c6/2a/3e/c62a3e65a0c8c38ef695144b447cd7dc.jpg" },
            { name: "Geometric Patterns", prompt: "geometric patterns", src: "https://i.pinimg.com/736x/b5/1c/99/b51c99f3d03d029d1dea464b89b4329c.jpg" },
            { name: "Bubble Border", prompt: "educational bubble border", src: "https://image.slidesdocs.com/responsive-images/docs/stationery-for-education-in-a-bubble-page-border-background-word-template_3737a7d4a6__1131_1600.jpg" },
            { name: "Green Math", prompt: "green math theme", src: "https://image.slidesdocs.com/responsive-images/docs/simplifying-math-with-a-touch-of-green-page-border-background-word-template_3241e560c8__1131_1600.jpg" },
            { name: "Pencil Art", prompt: "pencil and paper art", src: "https://clipart-library.com/images/pi7r57ndT.jpg" },
            { name: "Fantasy Landscape", prompt: "fantasy landscape", src: "https://i.pinimg.com/736x/bb/94/11/bb94116a9f46a6e4a54533f082bf4cfb.jpg" },
            { name: "Chalkboard", prompt: "school chalkboard background", src: "https://wallpapers.com/images/hd/school-picture-background-3w7ny3s5pak6kw2l.jpg" }
        ];

        $(document).ready(function() {
            const $themeSelectorContainer = $('#themeSelectorContainer');
            PREDEFINED_THEMES.forEach((theme, index) => {
                const $img = $('<img>')
                    .attr('src', theme.src)
                    .attr('alt', theme.name) // Use theme name for alt text
                    .data('theme-prompt', theme.prompt + " style")
                    .data('theme-src', theme.src); // Store the src also in data for easy retrieval
                if (index === 0) {
                    $img.addClass('selected');
                }
                $themeSelectorContainer.append($img);
            });

            $themeSelectorContainer.on('click', 'img', function() {
                $themeSelectorContainer.find('img').removeClass('selected');
                $(this).addClass('selected');
            });

            $('.card-color-theme .color-dot').on('click', function() {
                $('.card-color-theme .color-dot').removeClass('selected');
                $(this).addClass('selected');
            });

            $('#cardSize').on('change', function() {
                const selectedVal = $(this).val();
                if (selectedVal === 'custom') {
                    $('#customDimensionsRow').slideDown();
                } else {
                    $('#customDimensionsRow').slideUp();
                    const selectedOption = $(this).find('option:selected');
                    $('#cardWidthPx').val(selectedOption.data('width'));
                    $('#cardHeightPx').val(selectedOption.data('height'));
                }
                updatePreviewContainerDimensions();
            }).trigger('change');

            $('#cardWidthPx, #cardHeightPx').on('input', function() {
                if ($('#cardSize').val() === 'custom') {
                    updatePreviewContainerDimensions();
                }
            });

            function updatePreviewContainerDimensions() {
                let previewWidth = parseInt($('#cardWidthPx').val()) || 315;
                let previewHeight = parseInt($('#cardHeightPx').val()) || 440;
                
                const maxWidth = Math.min(450, $('.display-section').width() - 40); // Max width for the preview div on page
                if (previewWidth > maxWidth && maxWidth > 0) {
                    const ratio = maxWidth / previewWidth;
                    previewWidth = maxWidth;
                    previewHeight = Math.round(previewHeight * ratio);
                }

                $('#cardPreviewContainer').css({
                    width: previewWidth + 'px',
                    height: previewHeight + 'px'
                });
            }
            updatePreviewContainerDimensions();
            $(window).on('resize', updatePreviewContainerDimensions); // Adjust on window resize too


            $('#cardGenerationForm').on('submit', async function(e) {
                e.preventDefault();
                const $generateButton = $('#generateCardButton');
                $generateButton.prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Generating...');
                $('#loadingIndicator').show(); // Fallback if button text doesn't update
                $('#errorMessage').hide().text('');
                $('#cardPreviewContainer').empty().css('background-image', 'none');

                const aiPromptText = $('#aiPrompt').val();
                const genre = $('#genres').val();
                
                const selectedThemeImageElem = $('#themeSelectorContainer img.selected');
                const themePromptForAI = selectedThemeImageElem.data('theme-prompt') || "";
                const selectedThemeImageActualSrc = selectedThemeImageElem.data('theme-src'); // Get the original src from data

                const selectedColorDot = $('.card-color-theme .color-dot.selected');
                const colorPromptForAI = selectedColorDot.data('color-prompt') || "";
                const actualTextColor = selectedColorDot.data('color-value') || "#333333";
                
                let cardWidth, cardHeight;
                const cardSizeSelection = $('#cardSize').val();
                if (cardSizeSelection === 'custom') {
                    cardWidth = parseInt($('#cardWidthPx').val());
                    cardHeight = parseInt($('#cardHeightPx').val());
                } else {
                    const selectedOption = $('#cardSize').find('option:selected');
                    cardWidth = parseInt(selectedOption.data('width'));
                    cardHeight = parseInt(selectedOption.data('height'));
                }

                if (!aiPromptText.trim()) {
                    $('#errorMessage').text('Please enter an AI Prompt.').show();
                    $generateButton.prop('disabled', false).text('Create Card Design');
                    $('#loadingIndicator').hide();
                    return;
                }
                if (!cardWidth || !cardHeight || cardWidth <= 0 || cardHeight <= 0) {
                    $('#errorMessage').text('Please select a valid card size or enter custom dimensions.').show();
                    $generateButton.prop('disabled', false).text('Create Card Design');
                    $('#loadingIndicator').hide();
                    return;
                }

                let fullUserPrompt = aiPromptText;
                if (genre && genre !== "None" && genre !== "") { fullUserPrompt += `, ${genre} genre`; }
                if (themePromptForAI) { fullUserPrompt += `, ${themePromptForAI}`; }
                if (colorPromptForAI) { fullUserPrompt += `, with ${colorPromptForAI}`; }

                const numItems = parseInt($('#numCards').val()) || 1;
                
                const payload = {
                    userPrompt: fullUserPrompt,
                    cardName: "GenCard-" + aiPromptText.substring(0, 15).replace(/\s/g,'_'),
                    cardWidthPx: cardWidth,
                    cardHeightPx: cardHeight,
                    imageOutputFormat: "png", // Or "webp"
                    numItemsToGenerate: numItems,
                    defaultTextColor: actualTextColor,
                    // No need to send forcePredefinedImage to backend if backend handles its own fallback.
                    // Frontend will decide based on backend response and checkbox.
                };
                console.log("Sending payload:", payload);

                try {
                    const response = await fetch('http://localhost:5001/api/cards/generate-full-card', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const data = await response.json();
                    $('#loadingIndicator').hide();
                    $generateButton.prop('disabled', false).text('Create Card Design');

                    if (response.ok && data.card) {
                        console.log("Card generated (backend response):", data);
                        
                        let finalCardData = JSON.parse(JSON.stringify(data.card)); // Deep clone to modify for rendering
                        
                        if (!data.imageWasAIgenerated && $('#useSelectedThemeOnAIFail').is(':checked') && selectedThemeImageActualSrc) {
                            console.log("AI image failed or was placeholder, AND checkbox checked. Using selected theme image as fallback:", selectedThemeImageActualSrc);
                            
                            if (finalCardData.elements && finalCardData.elements.length > 0) {
                                let imageElement = finalCardData.elements.find(el => el.type === 'image' && el.zIndex === 0);
                                if (imageElement) {
                                    imageElement.imageUrl = selectedThemeImageActualSrc;
                                } else { // If no background image element was created by backend (e.g. even placeholder failed)
                                    finalCardData.elements.unshift({
                                        elementId: 'frontend-fallback-' + Date.now(), type: 'image', imageUrl: selectedThemeImageActualSrc,
                                        x: 0, y: 0, width: finalCardData.widthPx, height: finalCardData.heightPx, zIndex: 0, rotation: 0
                                    });
                                    finalCardData.elements.sort((a, b) => (a.zIndex || 0) - (b.zIndex || 0));
                                }
                            } else { // No elements array at all, create it with the image
                                 finalCardData.elements = [{
                                    elementId: 'frontend-fallback-' + Date.now(), type: 'image', imageUrl: selectedThemeImageActualSrc,
                                    x: 0, y: 0, width: finalCardData.widthPx, height: finalCardData.heightPx, zIndex: 0, rotation: 0
                                }];
                            }
                        } else if (!data.imageWasAIgenerated) {
                            console.log("AI image failed or was placeholder, and checkbox NOT checked or no theme selected. Backend's image will be used (if any).");
                            // data.card.elements[0].imageUrl already contains the backend's placeholder from DEFAULT_PLACEHOLDER_IMAGE_URL if backend set it.
                        }
                        renderCard(finalCardData, cardWidth, cardHeight);
                    } else {
                        $('#errorMessage').text(data.message || 'Error generating card. Details: ' + (data.details || JSON.stringify(data.error) || 'Unknown error')).show();
                    }
                } catch (error) {
                    $('#loadingIndicator').hide();
                    $generateButton.prop('disabled', false).text('Create Card Design');
                    $('#errorMessage').text('Network error or server unavailable: ' + error.message).show();
                    console.error("Fetch error:", error);
                }
            });

            function renderCard(cardData, targetCardWidth, targetCardHeight) {
                const $previewContainer = $('#cardPreviewContainer');
                $previewContainer.empty();

                let displayWidth = targetCardWidth;
                let displayHeight = targetCardHeight;
                const maxWidth = Math.min(450, $('.display-section').width() ? $('.display-section').width() - 40 : 450) ;

                if (displayWidth > maxWidth && maxWidth > 0) {
                    const ratio = maxWidth / displayWidth;
                    displayWidth = maxWidth;
                    displayHeight = Math.round(displayHeight * ratio);
                }
                
                $previewContainer.css({
                    width: displayWidth + 'px',
                    height: displayHeight + 'px',
                    backgroundColor: cardData.metadata?.backgroundColor || '#FFFFFF'
                });

                if (cardData.elements && Array.isArray(cardData.elements)) {
                    // Ensure elements are sorted by zIndex for correct layering
                    const sortedElements = [...cardData.elements].sort((a, b) => (a.zIndex || 0) - (b.zIndex || 0));

                    sortedElements.forEach(element => {
                        const $el = $('<div></div>').addClass('card-element').addClass(element.type);
                        const scaleX = displayWidth / targetCardWidth;
                        const scaleY = displayHeight / targetCardHeight;

                        $el.css({
                            left: (element.x || 0) * scaleX + 'px',
                            top: (element.y || 0) * scaleY + 'px',
                            width: (element.width || 100) * scaleX + 'px',
                            height: (element.height || 50) * scaleY + 'px',
                            zIndex: element.zIndex || 0,
                            transform: `rotate(${element.rotation || 0}deg)`
                        });

                        if (element.type === 'image' && element.imageUrl) {
                            $el.css('background-image', `url(${element.imageUrl})`);
                        } else if (element.type === 'text') {
                            let textContent = element.content || '';
                            textContent = textContent.replace(/\r\n/g, '<br>').replace(/\n/g, '<br>');
                            $el.html(textContent);
                            const originalFontSize = parseFloat(element.fontSize || '22px'); // Use '22px' as a string for parseFloat
                            // Ensure Math.min(scaleX, scaleY) is not zero or too small
                            const effectiveScale = Math.max(0.1, Math.min(scaleX, scaleY)); // Prevent font size from becoming too tiny or zero
                            const scaledFontSize = Math.max(8, originalFontSize * effectiveScale); // Min font size of 8px
                            
                            $el.css({
                                fontSize: scaledFontSize + 'px',
                                fontFamily: element.fontFamily || 'Arial',
                                color: element.color || '#333333',
                                textAlign: element.textAlign || 'center',
                                fontWeight: element.fontWeight || 'normal',
                                fontStyle: element.fontStyle || 'normal',
                            });
                        }
                        $previewContainer.append($el);
                    });
                }
            }
        });
    </script>
</body>
</html>