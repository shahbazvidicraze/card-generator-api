<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Card Generator</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #2c2c3e;
            color: #f0f0f0;
            padding-top: 20px;
            font-family: sans-serif;
        }

        .form-section,
        .display-section {
            background-color: #3a3a50;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .form-control,
        .custom-select {
            background-color: #4a4a63;
            color: #f0f0f0;
            border: 1px solid #5a5a76;
        }

        .form-control::placeholder {
            color: #a0a0b8;
        }

        .form-control:focus,
        .custom-select:focus {
            background-color: #50506a;
            color: #f0f0f0;
            border-color: #7a7ab0;
            box-shadow: none;
        }

        .btn-primary {
            background-color: #7a7ab0;
            border-color: #7a7ab0;
            width: 100%;
        }

        .btn-primary:hover {
            background-color: #686898;
            border-color: #686898;
        }

        .btn-primary:disabled {
            background-color: #5a5a76;
            border-color: #5a5a76;
        }

        .theme-selector {
            display: flex;
            flex-wrap: wrap;
        }

        .theme-selector img,
        .theme-selector .upload-theme-option {
            width: 80px;
            height: 100px;
            object-fit: cover;
            border: 3px solid transparent;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: border-color 0.2s ease-in-out, transform 0.2s ease-in-out;
        }

        .theme-selector img:hover,
        .theme-selector .upload-theme-option:hover {
            transform: scale(1.05);
        }

        .theme-selector img.selected,
        .theme-selector .upload-theme-option.selected {
            border-color: #a0a0ff;
            box-shadow: 0 0 8px #a0a0ff;
        }

        .theme-selector .upload-theme-option {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            background-color: #5a5a76;
            color: #c0c0d8;
            font-size: 2em;
            border-style: dashed;
            border-color: #7a7ab0;
        }

        .theme-selector .upload-theme-option span {
            font-size: 0.3em;
            margin-top: 5px;
        }

        .card-color-theme .color-dot {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid #6c6c85;
            cursor: pointer;
            margin-right: 5px;
            display: inline-block;
            transition: box-shadow 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }

        .card-color-theme .color-dot.selected {
            border-color: #fff;
            box-shadow: 0 0 0 3px #a0a0ff;
        }

        /* Card Flip Animation CSS */
        .flip-card-container {
            /* New wrapper for the main preview to handle perspective */
            perspective: 1000px;
            margin: 20px auto;
            /* Centering like #cardPreviewContainer */
        }

        #cardPreviewContainer {
            /* This is now the flippable inner part */
            width: 315px;
            height: 440px;
            /* Default, updated by JS */
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
            margin: auto;
            /* Removed margin, border, box-shadow as these go on .card-preview-base now */
        }

        #cardPreviewContainer.flipped {
            transform: rotateY(180deg);
        }

        #cardPreviewContainer.flipped #cardBack{
            z-index: 10;
        }
        .card-face {
            /* Common for front and back */
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            /* Safari */
            backface-visibility: hidden;
            border-radius: inherit;
            /* Inherit from #cardPreviewContainer if it had one */
        }

        #cardFront {
            /* background-color: #fff; /* Set by JS or card data */
            /* Elements are rendered here */
        }

        #cardBack {
            /* background-color: #222; /* Default back color */
            background-size: cover;
            background-position: center;
            transform: rotateY(180deg);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            top: 0;
            /* For any text on back if needed */
        }

        .card-preview-base {
            /* Applied to #cardFront and #cardBack */
            border: 1px solid #5a5a76;
            background-color: #fff;
            /* Default if not overridden */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            border-radius: 7px;
            /* Example border radius */
            width: 100%;
            height: 100%;
            /* Fill their parent */
        }

        /* Card Back Uploader Specific */
        #cardBackPreview {
            width: 80px;
            height: 100px;
            object-fit: cover;
            border: 2px solid #5a5a76;
            border-radius: 5px;
            margin-top: 5px;
            background-color: #4a4a63;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #a0a0b8;
        }

        #cardBackPreview img {
            max-width: 100%;
            max-height: 100%;
            border-radius: 3px;
        }

        /* Thumbnail Styling */
        #deckThumbnailsContainer {
            display: flex;
            flex-wrap: nowrap;
            overflow-x: auto;
            padding: 10px 0;
            justify-content: flex-start;
        }

        .card-preview-thumbnail-wrapper {
            flex-shrink: 0;
            margin: 0 5px;
            cursor: pointer;
            border: 3px solid transparent;
            border-radius: 7px;
            padding: 2px;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

        .card-preview-thumbnail-wrapper.selected-thumb>.card-preview-base {
            /* Apply to the inner card content div */
            border-color: #a0a0ff !important;
            box-shadow: 0 0 10px #a0a0ff !important;
        }

        .card-preview-thumbnail-wrapper .card-preview-base {
            /* Thumbnail content itself */
            margin: 0;
            width: 70px;
            height: 98px;
        }

        #deckThumbnailsContainer {
            display: flex;
            /* Use flexbox for horizontal layout */
            flex-wrap: nowrap;
            /* Prevent wrapping to new line by default */
            overflow-x: auto;
            /* Allow horizontal scrolling if many thumbs */
            padding: 10px 0;
            justify-content: center;
            /* Align thumbs to the start */
        }

        .card-preview-thumbnail-wrapper {
            flex-shrink: 0;
            /* Prevent thumbnails from shrinking */
            margin: 0 5px;
            /* Spacing between thumbnails */
            cursor: pointer;
            border: 3px solid transparent;
            border-radius: 5px;
            padding: 2px;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

        .card-preview-thumbnail-wrapper.selected-thumb>.card-preview-base {
            border-color: #a0a0ff !important;
            /* Highlight color for selected thumbnail */
            box-shadow: 0 0 10px #a0a0ff !important;
            padding: 1px;
        }

        .card-preview-thumbnail-wrapper .card-preview-base {
            /* Thumbnail content itself */
            margin: 0;
            /* Reset margin for the inner div */
            width: 70px;
            /* Fixed width for thumbnail card content */
            height: 98px;
            /* Fixed height for thumbnail (maintaining ~Poker aspect ratio) */
        }

        .card-element {
            position: absolute;
            box-sizing: border-box;
        }

        .card-element.image {
            background-size: cover;
            background-position: center;
        }

        .card-element.text {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2px;
            /* Reduced padding for thumbnails */
            overflow-wrap: break-word;
            word-wrap: break-word;
            white-space: pre-wrap;
            overflow-y: hidden;
            /* Hide scroll on thumbs, main can have auto */
        }

        label {
            margin-bottom: .3rem;
            font-size: 0.9em;
        }

        .small-label {
            font-size: 0.8em;
            color: #c0c0d8;
        }

        #loadingIndicator {
            display: none;
            text-align: center;
            margin-top: 15px;
        }

        .form-group {
            margin-bottom: 0.8rem;
        }

        h3,
        h5,
        h6 {
            font-weight: 300;
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <h3 class="text-center mb-4">Create your Card Design</h3>
        <div class="row">
            <div class="col-lg-5 col-md-12">
                <div class="form-section">
                    <form id="cardGenerationForm">
                        <div class="form-group">
                            <label for="boxName">Deck/Box Name</label>
                            <input type="text" class="form-control" id="boxName" placeholder="e.g., My Awesome Math Deck" value="My New Card Deck">
                        </div>
                        <!-- AI Prompt -->
                        <div class="form-group">
                            <label for="aiPrompt">AI Prompt (Describe card content)</label>
                            <textarea class="form-control" id="aiPrompt" rows="3"
                                placeholder="e.g., Mathematics learning game">Mathematics learning game for school children</textarea>
                        </div>
                        <!-- Genres & Card Size -->
                        <div class="row">
                            <div class="form-group col-md-6"><label for="genres">Genres (for AI)</label><select
                                    class="custom-select" id="genres">
                                    <option selected value="Educational">Educational</option>
                                    <option value="Fantasy">Fantasy</option>
                                </select></div>
                            <div class="form-group col-md-6"><label for="cardSize">Card size</label>
                                <select class="custom-select" id="cardSize">
                                    <option value="63x88" data-width="315" data-height="440" selected>Poker (63x88mm)
                                    </option>
                                    <option value="57x89" data-width="285" data-height="445">Bridge (57x89mm)</option>
                                    <option value="70x120" data-width="350" data-height="600">Tarot (70x120mm)</option>
                                    <option value="custom">Custom Pixels</option>
                                </select>
                            </div>
                        </div>
                        <!-- Custom Dimensions -->
                        <div class="row" id="customDimensionsRow" style="display: none;">
                            <div class="form-group col-md-6"><label for="cardWidthPx">Card Width (px)</label><input
                                    type="number" class="form-control" id="cardWidthPx" value="315"></div>
                            <div class="form-group col-md-6"><label for="cardHeightPx">Card Height (px)</label><input
                                    type="number" class="form-control" id="cardHeightPx" value="440"></div>
                        </div>
                        <!-- Number of Cards -->
                        <div class="form-group">
                            <label for="numCardsInDeck">How many Cards per Deck</label>
                            <select class="custom-select" id="numCardsInDeck">
                                <option value="1">1</option>
                                <option value="5" selected>5</option>
                                <option value="10">10</option>
                                <option value="20">20</option>
                                <option value="30">30</option>
                            </select>
                        </div>
                        <!-- Theme Selector -->
                        <div class="form-group">
                            <label>Theme (Select or Upload for Background)</label>
                            <div class="theme-selector" id="themeSelectorContainer">
                                <div class="upload-theme-option" id="uploadThemeBtn" title="Upload Custom Image">
                                    +<span>Upload</span></div>
                                <input type="file" id="customImageUpload" accept="image/*" style="display: none;">
                            </div>
                        </div>
                        <!-- Image Usage Preference -->
                        <div class="form-group">
                            <label for="imageUsagePreference">Background Image Preference</label>
                            <select class="custom-select" id="imageUsagePreference">
                                <option value="ai_only_white_fallback">AI Image (placeholder on fail)</option>
                                <option value="ai_then_selected_theme" selected>AI Image (use selected Theme on AI fail)
                                </option>
                                <option value="selected_theme_only">Use Selected Theme Image Only</option>
                            </select>
                        </div>
                        <!-- Accent Color -->
                        <div class="form-group">
                            <label>Accent Color (for text & AI image)</label>
                            <div class="card-color-theme">
                                <span class="color-dot" style="background-color: #000000;"
                                    data-color-prompt="tomato red accent" data-color-value="#000000"></span>
                                <span class="color-dot" style="background-color: #ff3a17;"
                                    data-color-prompt="tomato red accent" data-color-value="#ff3a17"></span>
                                <span class="color-dot selected" style="background-color: #4682B4;"
                                    data-color-prompt="steel blue accent" data-color-value="#4682B4"></span>
                                <span class="color-dot" style="background-color: #FFD700;"
                                    data-color-prompt="gold accent" data-color-value="#FFD700"></span>
                                <span class="color-dot" style="background-color: #90EE90;"
                                    data-color-prompt="light green accent" data-color-value="#90EE90"></span>
                                <span class="color-dot" style="background-color: #FFB6C1;"
                                    data-color-prompt="light pink accent" data-color-value="#FFB6C1"></span>
                                <span class="color-dot" style="background-color: #FFFFFF;"
                                    data-color-prompt="white accent" data-color-value="#FFFFFF"></span>
                            </div>
                        </div>
                        <!-- Card Back Theme Selector -->
                        <div class="form-group">
                            <label for="customCardBackUpload">Card Back Design (Select or Upload)</label>
                            <div class="theme-selector" id="cardBackThemeSelectorContainer">
                                <div class="upload-theme-option" id="uploadCardBackBtn"
                                    title="Upload Custom Back Image">+<span>Upload Back</span></div>
                                <input type="file" id="customCardBackUpload" accept="image/*" style="display: none;">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary mt-3" id="generateCardButton">Create Card
                            Design</button>
                        <div id="loadingIndicator" class="mt-3">
                            <div class="spinner-border text-light" role="status"><span class="sr-only">Loading...</span>
                            </div>
                        </div>
                        <div id="errorMessage" class="alert alert-danger mt-3" style="display: none;"></div>
                    </form>
                </div>
            </div>
            <div class="col-lg-7 col-md-12">
                <div class="display-section">
                    <h5 class="text-center">Generated Card Version</h5>
                    <div id="cardPreviewContainer"> <!-- This div will now flip -->
                        <div id="cardFront" class="card-face card-preview-base">
                            <!-- Card front elements will be injected here -->
                        </div>
                        <div id="cardBack" class="card-face card-preview-base">
                            <!-- Card back image will be set here -->
                            <span>Card Back</span> <!-- Default text -->
                        </div>
                    </div>
                    <button type="button" class="btn btn-info btn-sm mt-2 mx-auto d-block" id="flipCardBtn"
                        style="display: none; max-width: 150px;">Flip to Back</button>
                    <div id="deckThumbnailsContainerWrapper" class="mt-4" style="display:none;">
                        <h6 class="text-center">Deck Previews</h6>
                        <div id="deckThumbnailsContainer">
                            <!-- Thumbnails will be injected here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script>
        const PREDEFINED_THEMES = [
            { name: "Abstract Flow", prompt: "abstract flowing colors", src: "public/images/themes/2.jpg" },
            { name: "Abstract Flow", prompt: "abstract flowing colors", src: "public/images/themes/1.jpg" },
            { name: "Green Math", prompt: "green math theme", src: "public/images/themes/11.jpg" },
            { name: "Pencil Art", prompt: "pencil and paper art", src: "public/images/themes/6.jpg" },
            { name: "Fantasy Landscape", prompt: "fantasy landscape", src: "public/images/themes/7.jpg" },
            { name: "Chalkboard", prompt: "school chalkboard background", src: "public/images/themes/8.jpg" }
        ];
        // Predefined themes for CARD BACK (can be same or different from front themes)
        const PREDEFINED_BACK_THEMES = [
            { name: "Abstract Back 1", src: "public/images/card-backs/1.jpg" },
            { name: "Geometric Back 1", src: "public/images/card-backs/2.jpg" },
            { name: "Geometric Patterns", src: "public/images/card-backs/3.jpg" },
            { name: "Bubble Border", src: "public/images/card-backs/4.jpg" },
            { name: "Green Math", src: "public/images/card-backs/5.jpg" },
            { name: "Pencil Art", src: "public/images/card-backs/6.jpg" } // Simple placeholder
        ];

        let uploadedImageBase64 = null;     // For custom FRONT theme
        let currentSelectedThemeSrc = null; // For card FRONT (predefined src or uploadedImageBase64)
        
        let uploadedCardBackBase64 = null;  // For custom uploaded CARD BACK
        let currentSelectedCardBackSrc = null; // For card BACK (predefined back src or uploadedCardBackBase64)

        let dataCache = {
            fullDeckData: [], imageWasAIgenerated: false,
            originalCardWidth: 315, originalCardHeight: 440,
            themeSrcSelectedAtGeneration: null
        };
        const DEFAULT_FRONTEND_PLACEHOLDER_URL = "https://via.placeholder.com/150x200.png?text=No+Theme";
        
        const DEFAULT_CARD_BACK_PLACEHOLDER_TEXT = "";
        let uploadedCardBackImageBase64 = null; // For a custom uploaded back image
        let isCardFlipped = false; // Tracks the state of the main card preview;

        async function imageUrlToBase64(url) {
            if (!url || url.startsWith('data:image')) { // If already base64 or null/empty, return as is
                return url;
            }
            console.log("Attempting to convert URL to Base64:", url);
            try {
                // IMPORTANT: Add 'mode: "cors"' if you are fetching from a different origin
                // and that origin supports CORS. If not, this will fail for many external URLs.
                // For truly robust solution for any URL, a backend proxy for fetching images is needed.
                const response = await fetch(url); // Add { mode: 'cors' } if appropriate
                if (!response.ok) {
                    throw new Error(`CORS or Network error fetching image for base64: ${response.status} ${response.statusText} URL: ${url}`);
                }
                const blob = await response.blob();
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result);
                    reader.onerror = (error) => {
                        console.error("FileReader error:", error);
                        reject(error);
                    };
                    reader.readAsDataURL(blob);
                });
            } catch (error) {
                console.error("Error in imageUrlToBase64 for URL:", url, error);
                return null; // Indicate failure
            }
        }

        $(document).ready(function () {
            const $themeSelectorContainer = $('#themeSelectorContainer');
            const $uploadThemeBtn = $('#uploadThemeBtn');
            const $cardBackThemeSelectorContainer = $('#cardBackThemeSelectorContainer');
            const $uploadCardBackBtn = $('#uploadCardBackBtn');

            // --- Populate PREDEFINED FRONT THEMES ---
            PREDEFINED_THEMES.forEach((theme, index) => {
                const $img = $('<img>').attr('src', theme.src).attr('alt', theme.name)
                    .data('theme-prompt', theme.prompt + " style").data('theme-src', theme.src)
                    .data('is-predefined', true);
                if (index === 0) { $img.addClass('selected'); currentSelectedThemeSrc = theme.src; }
                $uploadThemeBtn.before($img);
            });

            // --- Populate PREDEFINED BACK THEMES ---
            PREDEFINED_BACK_THEMES.forEach((theme, index) => {
                const $img = $('<img>').attr('src', theme.src).attr('alt', theme.name + " Back")
                    .data('theme-src', theme.src) // Only need src for back
                    .data('is-predefined-back', true);
                if (index === 0 && !uploadedCardBackBase64) { // Select first if no custom back uploaded
                    $img.addClass('selected');
                    currentSelectedCardBackSrc = theme.src;
                }
                $uploadCardBackBtn.before($img);
            });

            // Handle theme selection (predefined, uploaded preview, or upload button itself)
            $themeSelectorContainer.on('click', 'img, .upload-theme-option', function () {
                const $clickedElement = $(this);
                $themeSelectorContainer.find('img, .upload-theme-option').removeClass('selected');
                $clickedElement.addClass('selected');

                if ($clickedElement.data('is-predefined')) { // Clicked a predefined theme image
                    currentSelectedThemeSrc = $clickedElement.data('theme-src');
                    // If there was an uploaded image preview, it's now deselected.
                    // The #uploadThemeBtn's content (if it was showing a preview) doesn't need to change yet,
                    // unless you want to revert it back to "+" when a predefined is clicked.
                    // For simplicity, let's allow the upload button to keep its preview even if deselected.
                } else if ($clickedElement.data('is-uploaded-preview')) { // Clicked the uploaded image preview
                    currentSelectedThemeSrc = $clickedElement.data('theme-src'); // which is uploadedImageBase64
                } else if ($clickedElement.is('#uploadThemeBtn')) { // Clicked the actual upload button
                    if (uploadedImageBase64 && $clickedElement.find('img').length > 0) {
                        // If it's already showing an uploaded image preview and was clicked again
                        currentSelectedThemeSrc = uploadedImageBase64;
                    } else {
                        // Trigger file input
                        $('#customImageUpload').val(null).click();
                        // Don't set currentSelectedThemeSrc yet, wait for file upload
                    }
                }
            });

            $('#customImageUpload').on('change', function (event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        uploadedImageBase64 = e.target.result;
                        currentSelectedThemeSrc = uploadedImageBase64; // Update global tracker

                        // Remove any existing uploaded theme preview image
                        $themeSelectorContainer.find('.uploaded-theme-preview').remove();

                        // Create new image element for the uploaded theme
                        const $uploadedImgPreview = $('<img>')
                            .attr('src', uploadedImageBase64)
                            .attr('alt', 'Uploaded Theme')
                            .addClass('uploaded-theme-preview') // Specific class for easy removal/identification
                            .data('theme-src', uploadedImageBase64) // Store its own src
                            .data('is-uploaded-preview', true) // Mark it as such
                            .data('theme-prompt', "custom uploaded image"); // Generic prompt for AI if needed

                        // Deselect all themes and select the new one
                        $themeSelectorContainer.find('img, .upload-theme-option').removeClass('selected');
                        $uploadedImgPreview.addClass('selected');

                        // Insert the new uploaded theme preview before the upload button
                        $uploadThemeBtn.before($uploadedImgPreview);

                    }
                    reader.readAsDataURL(file);
                }
                $(this).val('');
            });

             // --- Event Handlers for CARD BACK Selection & Upload ---
            $cardBackThemeSelectorContainer.on('click', 'img, .upload-theme-option', function() {
                const $clickedElement = $(this);
                $cardBackThemeSelectorContainer.find('img, .upload-theme-option').removeClass('selected');
                $clickedElement.addClass('selected');

                if ($clickedElement.data('is-predefined-back')) {
                    currentSelectedCardBackSrc = $clickedElement.data('theme-src');
                    uploadedCardBackBase64 = null; // Clear custom uploaded back
                    $uploadCardBackBtn.html('+<span>Upload Back</span>'); // Reset upload button
                } else if ($clickedElement.data('is-uploaded-back-preview')) { // Clicked the uploaded card back preview
                    currentSelectedCardBackSrc = $clickedElement.data('theme-src');
                } else if ($clickedElement.is('#uploadCardBackBtn')) { // Clicked the actual card back upload button
                    if (uploadedCardBackBase64 && $clickedElement.find('img').length > 0) {
                        currentSelectedCardBackSrc = uploadedCardBackBase64;
                    } else {
                        $('#customCardBackUpload').val(null).click(); // Trigger file input for card back
                    }
                }
                // Immediately update the main card's back if it's visible or for next flip
                updateMainCardBackDisplay();
            });

            $('#customCardBackUpload').on('change', function(event) { // This is for CARD BACK UPLOAD
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        uploadedCardBackBase64 = e.target.result;
                        currentSelectedCardBackSrc = uploadedCardBackBase64;

                        $cardBackThemeSelectorContainer.find('.uploaded-back-theme-preview').remove();
                        const $uploadedImgPreview = $('<img>')
                            .attr('src', uploadedCardBackBase64).attr('alt', 'Uploaded Card Back')
                            .addClass('uploaded-back-theme-preview selected') // Add selected class
                            .data('theme-src', uploadedCardBackBase64).data('is-uploaded-back-preview', true);
                        
                        $uploadCardBackBtn.before($uploadedImgPreview);
                        $cardBackThemeSelectorContainer.find('img[data-is-predefined-back], #uploadCardBackBtn').removeClass('selected');
                        $uploadedImgPreview.addClass('selected'); // Select the new one

                        updateMainCardBackDisplay();
                    }
                    reader.readAsDataURL(file);
                }
                $(this).val(''); // Reset
            });

            // --- Flip Card Logic ---
            $('#flipCardBtn').on('click', function() {
                const $preview = $('#cardPreviewContainer');
                $preview.toggleClass('flipped');
                $(this).text($preview.hasClass('flipped') ? 'Flip to Front' : 'Flip to Back');
            });

            $('.card-color-theme .color-dot').on('click', function () {
                $('.card-color-theme .color-dot').removeClass('selected');
                $(this).addClass('selected');
            });

            $('#cardSize').on('change', function () {
                const selectedVal = $(this).val();
                if (selectedVal === 'custom') {
                    $('#customDimensionsRow').slideDown();
                } else {
                    $('#customDimensionsRow').slideUp();
                    const selectedOption = $(this).find('option:selected');
                    $('#cardWidthPx').val(selectedOption.data('width'));
                    $('#cardHeightPx').val(selectedOption.data('height'));
                }
                updatePreviewContainerDimensions();
            }).trigger('change');

            $('#cardWidthPx, #cardHeightPx').on('input', function () {
                if ($('#cardSize').val() === 'custom') {
                    updatePreviewContainerDimensions();
                }
            });

            function updatePreviewContainerDimensions() {
                let currentCardWidth = parseInt($('#cardWidthPx').val()) || 315;
                let currentCardHeight = parseInt($('#cardHeightPx').val()) || 440;
                let displayWidth = currentCardWidth;
                let displayHeight = currentCardHeight;

                const parentWidth = $('.display-section').width();
                const maxWidth = Math.min(450, parentWidth ? parentWidth - 40 : 450);
                if (displayWidth > maxWidth && maxWidth > 0) {
                    const scale = maxWidth / displayWidth;
                    displayWidth = maxWidth;
                    displayHeight = Math.round(displayHeight * scale);
                }
                $('#cardPreviewContainer').css({ width: displayWidth + 'px', height: displayHeight + 'px' });
            }
            updatePreviewContainerDimensions();
            $(window).on('resize', updatePreviewContainerDimensions);


            $('#cardGenerationForm').on('submit', async function (e) {
                e.preventDefault();
                 const $generateButton = $('#generateCardButton');
                $generateButton.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Generating...');
                $('#errorMessage').hide().text('');
                $('#cardFront').empty(); // Clear only front face initially
                $('#cardBack').css('background-image', 'none').html(`<span>${DEFAULT_CARD_BACK_PLACEHOLDER_TEXT}</span>`);
                $('#deckThumbnailsContainer').empty(); 
                $('#deckThumbnailsContainerWrapper').hide().find('h6').hide();
                $('#flipCardBtn').hide(); 


                const aiPromptText = $('#aiPrompt').val();
                const genre = $('#genres').val();
                const themePromptForAI = $('#themeSelectorContainer .selected').data('theme-prompt') || "";
                // currentSelectedThemeSrc is already updated globally
                const boxName = $('#boxName').val().trim();
                const actualTextColor = $('.card-color-theme .color-dot.selected').data('color-value') || "#333333";

                let cardWidth, cardHeight;
                const cardSizeSelection = $('#cardSize').val();
                if (cardSizeSelection === 'custom') {
                    cardWidth = parseInt($('#cardWidthPx').val());
                    cardHeight = parseInt($('#cardHeightPx').val());
                } else {
                    cardWidth = parseInt($('#cardSize option:selected').data('width'));
                    cardHeight = parseInt($('#cardSize option:selected').data('height'));
                }

                if (!aiPromptText.trim()) { /* ... validation ... */ return; }
                if (!cardWidth || !cardHeight || cardWidth <= 0 || cardHeight <= 0) { /* ... validation ... */ return; }

                let fullUserPrompt = aiPromptText;
                if (genre && genre.toLowerCase() !== "none" && genre !== "") { fullUserPrompt += `, ${genre} genre`; }
                const imageUsagePref = $('#imageUsagePreference').val();
                if (imageUsagePref !== 'selected_theme_only' && themePromptForAI) {
                    fullUserPrompt += `, ${themePromptForAI}`;
                }

                const numCards = parseInt($('#numCardsInDeck').val()) || 1;

                let fullUserPromptForAI = aiPromptText; // Base for AI content generation
                if (genre && genre.toLowerCase() !== "none" && genre !== "") { fullUserPromptForAI += `, ${genre} genre`; }
                
                // Image generation prompt construction is now more nuanced
                // It combines the main content prompt with the selected front theme's specific prompt
                let imageGenerationUserPrompt = aiPromptText; // Start with main content
                if (themePromptForAI) { imageGenerationUserPrompt += `, ${themePromptForAI}`; } // Add theme style
                const colorPrompt = $('.card-color-theme .color-dot.selected').data('color-prompt') || "";
                if (colorPrompt) { imageGenerationUserPrompt += `, with ${colorPrompt}`; }


                // Prepare FALLBACK FRONT IMAGE (base64) for backend
                let fallbackFrontImageBase64 = null;
                if (currentSelectedThemeSrc) {
                    fallbackFrontImageBase64 = await imageUrlToBase64(currentSelectedThemeSrc);
                }

                // Prepare CARD BACK IMAGE (base64) for backend
                let cardBackImageForPayload = null;
                if (currentSelectedCardBackSrc) {
                    cardBackImageForPayload = await imageUrlToBase64(currentSelectedCardBackSrc);
                }
                
                const payload = {
                    boxName: boxName,
                    userPrompt: imageGenerationUserPrompt, // This is now more styled for the image AI
                    genre: genre, // Send separately if backend uses it for text AI or metadata
                    themePromptForAI: themePromptForAI, // Send theme prompt for metadata/AI
                    accentColorPrompt: colorPrompt, // Send for metadata/AI
                    accentColorHex: actualTextColor, // For text elements (backend also uses this)

                    defaultCardWidthPx: cardWidth, 
                    defaultCardHeightPx: cardHeight,
                    // imageAspectRatioForDeck: ..., // Let backend calculate or add UI for this
                    imageOutputFormatForDeck: "png", 
                    numCardsInDeck: numCards,
                    
                    cardBackImageDataUri: cardBackImageForPayload, // Base64 of selected/uploaded back
                    fallbackFrontImageBase64DataUri: fallbackFrontImageBase64 // Base64 of selected/uploaded front theme
                };
                console.log("Sending payload to /api/boxes/create-with-deck:", payload);

                try {
                    // Endpoint now creates a BOX and a DECK of cards within it
                    const response = await fetch('http://localhost:5001/api/boxes/create-with-deck', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                    });
                    const backendResponseData = await response.json();
                    // ... (handle loading/button state) ...

                    // if (response.ok && backendResponseData.box && backendResponseData.cards && backendResponseData.cards.length > 0) {
                    if (response.ok) {
                        console.log("Box and Deck received:", backendResponseData);
                        dataCache.currentBox = backendResponseData.box;
                        dataCache.currentDeck = JSON.parse(JSON.stringify(backendResponseData.cards)); // Store pristine deck
                        dataCache.imageWasAIgeneratedForDeck = backendResponseData.imageWasAIgenerated; // For the deck's front image
                        dataCache.originalCardWidth = cardWidth; 
                        dataCache.originalCardHeight = cardHeight;
                        // themeSrcSelectedAtGeneration is for the FRONT image fallback scenario handled by backend now
                        // but we can still store what was selected on frontend for consistency checks if needed
                        dataCache.themeSrcSelectedAtGeneration = currentSelectedThemeSrc; 


                        // The backend now handles which image (AI or fallback) is in card.cardFrontElements[0].imageUrl
                        // And card.cardBackElements[0].imageUrl (if back was provided)
                        const cardsToDisplay = dataCache.currentDeck;

                        if (cardsToDisplay.length > 0) {
                            displayMainCard(cardsToDisplay[0]); // Display the first card
                            const $thumbnailsContainer = $('#deckThumbnailsContainer');
                            $thumbnailsContainer.empty(); 
                            $('#deckThumbnailsContainerWrapper').show().find('h6').show();
                            cardsToDisplay.forEach((cardInst, idx) => {
                                renderThumbnail(cardInst, dataCache.originalCardWidth, dataCache.originalCardHeight, idx, $thumbnailsContainer, cardsToDisplay);
                            });
                            if ($thumbnailsContainer.children().length > 0) {
                                $thumbnailsContainer.children().first().addClass('selected-thumb');
                                $('#flipCardBtn').show(); // Show flip button
                            }
                        }
                    } else {
                        $('#errorMessage').text(data.message || 'Error generating card. Details: ' + (data.details || JSON.stringify(data.error) || 'Unknown error')).show();
                    }
                } catch (error) {
                    $('#loadingIndicator').hide();
                    $generateButton.prop('disabled', false).text('Create Card Design');
                    $('#errorMessage').text('Network error or server unavailable: ' + error.message).show();
                    console.error("Fetch error:", error);
                }
            });

            // Helper to update the main card's back display based on current selection or card data
            function updateMainCardBackDisplay(cardDataForBack = null) {
                let backImageUrlToUse = null;
                if (cardDataForBack && cardDataForBack.cardBackImageUrl) {
                    backImageUrlToUse = cardDataForBack.cardBackImageUrl; // Use specific card's back
                } else if (currentSelectedCardBackSrc) { // Fallback to globally selected/uploaded back
                    backImageUrlToUse = currentSelectedCardBackSrc;
                }
                
                if (backImageUrlToUse) {
                    $('#cardBack').css('background-image', `url(${backImageUrlToUse})`).html('');
                } else {
                    $('#cardBack').css('background-image', 'none').html(`<span>${DEFAULT_CARD_BACK_PLACEHOLDER_TEXT}</span>`);
                }
            }

            // New function to display a card in the main preview area
            function displayMainCard(cardData) { // Removed fullDeckContext if not directly used by this function
                console.log("DISPLAY_MAIN_CARD: Rendering card:", cardData.name);
                // console.log("Card data for main display:", JSON.stringify(cardData, null, 2).substring(0, 500));
                $('#cardPreviewContainer').data('currentCardData', cardData);

                // Render the FRONT face using the card's elements
                renderCardFace(cardData, dataCache.originalCardWidth, dataCache.originalCardHeight, $('#cardFront'), false);
                
                // Set the card BACK image using cardBackImageUrl from the cardData object
                let cardBackDisplayUrl = cardData.cardBackImageUrl || currentSelectedCardBackSrc || DEFAULT_FRONTEND_PLACEHOLDER_URL.replace("Theme","Card Back");
                $('#cardBack').css('background-image', `url(${cardBackDisplayUrl})`).html(cardBackDisplayUrl && (cardBackDisplayUrl.startsWith('http') || cardBackDisplayUrl.startsWith('data:')) ? '' : `<span>${DEFAULT_CARD_BACK_PLACEHOLDER_TEXT}</span>`);
                
                $('#cardPreviewContainer').removeClass('flipped');
                $('#flipCardBtn').text('Flip to Back').show();
            }

            function renderCardFace(cardData, baseCardWidth, baseCardHeight, $faceContainer, isThumbnailContent = false, fullDeckContext = null, faceType = 'front') {
                $faceContainer.empty();

                // THIS BLOCK IS WHERE THE ISSUE LIKELY IS FOR THUMBNAILS
                let displayWidth = isThumbnailContent ? $faceContainer.width() : dataCache.previewContainerDisplayWidth || baseCardWidth;
                let displayHeight = isThumbnailContent ? $faceContainer.height() : dataCache.previewContainerDisplayHeight || baseCardHeight;
                // If $faceContainer is the thumbnail's content div (e.g., .card-preview-thumbnail-content),
                // and its CSS sets width/height to 100% of its wrapper, then $faceContainer.width()
                // might be returning 0 if the wrapper (.card-preview-thumbnail-wrapper) hasn't been fully sized
                // by the browser yet, or if the content div itself hasn't rendered with a concrete size.

                // This CSS block applies to $faceContainer.
                // If isThumbnailContent is true, $faceContainer is the thumbnail's content div.
                // Its width/height should be 100% of its wrapper.
                // The wrapper (.card-preview-thumbnail-wrapper) should have a fixed pixel size set by CSS.
                if (!isThumbnailContent) { 
                     $faceContainer.css({
                        backgroundColor: cardData.metadata?.backgroundColor || '#fff',
                    });
                } else { 
                    $faceContainer.css({ // Styles for thumbnail content div
                        backgroundColor: cardData.metadata?.backgroundColor || '#fff',
                        width: '100%', height: '100%' // Fill wrapper
                    });
                }

                // This $faceContainer.css call might be overriding or conflicting if not careful.
                // The one above ALREADY sets width/height for thumbnails to 100%.
                // This one below seems to be intended for the main preview face.
                // HOWEVER, the displayWidth/displayHeight used here for scaling elements
                // need to be the *actual display dimensions* of the container.
                // $faceContainer.css({ // Apply to the direct container (.card-preview-base)
                //     width: displayWidth + 'px', height: displayHeight + 'px', // This is problematic for thumbnails if their CSS defines fixed size
                //     // ... other styles
                // });

                // Let's separate the sizing of the container from the dimensions used for scaling elements
                let containerActualDisplayWidth, containerActualDisplayHeight;

                if (isThumbnailContent) {
                    // For thumbnails, the wrapper sets the display size.
                    // The $faceContainer (content div) should fill this wrapper.
                    containerActualDisplayWidth = $faceContainer.parent().width(); // Get wrapper's width
                    containerActualDisplayHeight = $faceContainer.parent().height(); // Get wrapper's height
                    $faceContainer.css({ width: '100%', height: '100%' }); // Ensure it fills
                } else { // Main Preview
                    containerActualDisplayWidth = dataCache.previewContainerDisplayWidth || baseCardWidth;
                    containerActualDisplayHeight = dataCache.previewContainerDisplayHeight || baseCardHeight;
                    // The #cardFront (which is $faceContainer here) is already sized correctly relative to #cardPreviewContainer
                    // by CSS (width: 100%, height: 100%) and #cardPreviewContainer is sized by updatePreviewContainerDimensions
                }
                 // Common styles for the face itself
                $faceContainer.css({
                    backgroundColor: cardData.metadata?.backgroundColor || '#fff',
                    position: 'relative', // For absolute positioning of elements within
                    overflow: 'hidden'    // Clip elements
                    // Border and box-shadow are on .card-preview-base class which $faceContainer has
                });


                const elementsToRender = (faceType === 'back' && !isThumbnailContent) ? cardData.cardBackElements : cardData.cardFrontElements;

                if (elementsToRender && Array.isArray(elementsToRender) && elementsToRender.length > 0) {
                    const sortedElements = [...elementsToRender].sort((a, b) => (a.zIndex || 0) - (b.zIndex || 0));
                    renderElementsToContainer(sortedElements, $faceContainer, displayWidth, displayHeight, baseCardWidth, baseCardHeight, isThumbnailContent);
                } else {
                    const placeholderText = isThumbnailContent ? 'No Img' : (faceType === 'back' ? 'Card Back Empty' : 'No Front Elements');
                    $faceContainer.html(`<p style="text-align:center; padding-top:10px; font-size:0.8em; color:#888;">${placeholderText}</p>`);
                }
            }
            

            function renderThumbnail(cardData, originalCardWidth, originalCardHeight, index, $deckThumbsContainer, fullDeckContext) {
                const $thumbWrapper = $('<div></div>')
                    .addClass('card-preview-thumbnail-wrapper')
                    .data('card-index', index); // Store index to retrieve from fullDeckContext

                // Each thumbnail will have a front face for its content
                const $thumbFrontFace = $('<div></div>').addClass('card-preview-base card-preview-thumbnail-content');
                $thumbWrapper.append($thumbFrontFace);
                $deckThumbsContainer.append($thumbWrapper);

                $thumbWrapper.css({ width: '76px', height: '104px' }); // Size of the clickable wrapper

                // Thumbnails always show the cardFrontElements
                renderCardFace(cardData, originalCardWidth, originalCardHeight, $thumbFrontFace, true, fullDeckContext, 'front');

                $thumbWrapper.off('click').on('click', function() { 
                    const clickedIndex = $(this).data('card-index');
                    // THE VARIABLE `cardToDisplayFromDeck` IS USED HERE, BUT IT'S THE NAME OF A VARIABLE
                    // FROM A PREVIOUS VERSION OF THE SUBMIT HANDLER'S MAP FUNCTION.
                    // WE NEED TO USE `fullDeckContext` WHICH IS PASSED INTO `renderThumbnail`.
                    const cardDataForMainDisplay = fullDeckContext[clickedIndex]; // <<<< USE fullDeckContext
                    
                    if (!cardDataForMainDisplay) { // Check if the card data exists
                        console.error("Thumbnail click: Card data not found in fullDeckContext for index", clickedIndex);
                        return;
                    }

                    // Clone the specific card data from the deck for modification
                    let cardToProcessForMainView = JSON.parse(JSON.stringify(cardDataForMainDisplay));
                    
                    const imageUsagePrefOnClick = $('#imageUsagePreference').val();
                    const aiSucceededOnClick = dataCache.imageWasAIgenerated; // Use cached status from initial generation
                    const themeSrcForFallbackOnClick = dataCache.themeSrcSelectedAtGeneration; // Use theme selected at initial generation

                    let finalImageForMainDisplay;
                    if (imageUsagePrefOnClick === 'selected_theme_only') {
                        finalImageForMainDisplay = themeSrcForFallbackOnClick || DEFAULT_FRONTEND_PLACEHOLDER_URL;
                    } else if (imageUsagePrefOnClick === 'ai_then_selected_theme') {
                        finalImageForMainDisplay = aiSucceededOnClick ? 
                            cardToProcessForMainView.elements.find(el=>el.type==='image' && el.zIndex===0)?.imageUrl : 
                            (themeSrcForFallbackOnClick || DEFAULT_FRONTEND_PLACEHOLDER_URL);
                    } else { // ai_only_white_fallback
                         finalImageForMainDisplay = cardToProcessForMainView.elements.find(el=>el.type==='image' && el.zIndex===0)?.imageUrl;
                         // If backend's placeholder was empty string and AI failed, use a frontend default
                         if (!finalImageForMainDisplay && !aiSucceededOnClick) {
                            finalImageForMainDisplay = DEFAULT_FRONTEND_PLACEHOLDER_URL;
                         }
                    }
                    // Ultimate safety net
                    if (!finalImageForMainDisplay) finalImageForMainDisplay = DEFAULT_FRONTEND_PLACEHOLDER_URL;
                    
                    if (!cardToProcessForMainView.elements) cardToProcessForMainView.elements = [];
                    let imageElement = cardToProcessForMainView.elements.find(el => el.type === 'image' && el.zIndex === 0);
                    if(imageElement) {
                        imageElement.imageUrl = finalImageForMainDisplay;
                    } else { 
                        cardToProcessForMainView.elements.unshift({
                            elementId: 'mainfb-' + Date.now(), type: 'image', imageUrl: finalImageForMainDisplay,
                            x:0, y:0, width: cardToProcessForMainView.widthPx, height: cardToProcessForMainView.heightPx,
                            zIndex:0, rotation:0
                        });
                        cardToProcessForMainView.elements.sort((a,b)=>(a.zIndex||0)-(b.zIndex||0));
                    }

                     renderCardFace(cardToProcessForMainView, dataCache.originalCardWidth, dataCache.originalCardHeight, $('#cardFront'), false, fullDeckContext);
                    // Update card back for the main preview
                    if (uploadedCardBackBase64) {
                        $('#cardBack').css('background-image', `url(${uploadedCardBackBase64})`).html('');
                    } else {
                        $('#cardBack').css('background-image', 'none').html('<span>Card Back</span>');
                    }
                    $('#cardPreviewContainer').removeClass('flipped'); // Show front

                    displayMainCard(cardToProcessForMainView, fullDeckContext); // Pass fullDeckContext again if displayMainCard uses it
                    
                    $('#deckThumbnailsContainer .card-preview-thumbnail-wrapper').removeClass('selected-thumb');
                    $(this).addClass('selected-thumb');
                });
            }

            function renderElementsToContainer(elements, $container, displayWidth, displayHeight, cardActualWidth, cardActualHeight, isThumbnailFlag) {
                elements.forEach(element => {
                    const $el = $('<div></div>').addClass('card-element').addClass(element.type);

                    const scaleX = (cardActualWidth === 0) ? 1 : displayWidth / cardActualWidth;
                    const scaleY = (cardActualHeight === 0) ? 1 : displayHeight / cardActualHeight;

                    $el.css({
                        left: (element.x || 0) * scaleX + 'px',
                        top: (element.y || 0) * scaleY + 'px',
                        width: (element.width || 100) * scaleX + 'px',
                        height: (element.height || 50) * scaleY + 'px',
                        zIndex: element.zIndex || 0,
                        transform: `rotate(${element.rotation || 0}deg)`
                    });

                    if (element.type === 'image' && element.imageUrl) {
                        $el.css('background-image', `url(${element.imageUrl})`);
                    } else if (element.type === 'text') {
                        let textContent = element.content || '';
                        textContent = textContent.replace(/\r\n/g, '<br>').replace(/\n/g, '<br>');
                        $el.html(textContent);

                        const originalFontSize = parseFloat(element.fontSize || '22px');
                        const fontScale = Math.min(scaleX, scaleY);
                        // More nuanced font scaling for thumbnails vs main card
                        let scaledFontSize;
                        if (isThumbnailFlag) {
                            scaledFontSize = Math.max(6, originalFontSize * fontScale * 0.8); // Smaller for thumbs
                        } else {
                            scaledFontSize = Math.max(10, originalFontSize * fontScale);
                        }
                        // Prevent overly large fonts if scaling up significantly
                        scaledFontSize = Math.min(scaledFontSize, originalFontSize * 1.5);


                        $el.css({
                            fontSize: scaledFontSize + 'px',
                            fontFamily: element.fontFamily || 'Arial',
                            color: element.color || '#333333',
                            textAlign: element.textAlign || 'center',
                            fontWeight: element.fontWeight || 'normal',
                            fontStyle: element.fontStyle || 'normal',
                        });
                    }
                    $container.append($el);
                });
            }

            // Initializations
            if (PREDEFINED_THEMES.length > 0 && !currentSelectedThemeSrc) { currentSelectedThemeSrc = PREDEFINED_THEMES[0].src; }
            if (PREDEFINED_BACK_THEMES.length > 0 && !currentSelectedCardBackSrc) { 
                currentSelectedCardBackSrc = PREDEFINED_BACK_THEMES[0].src; 
                $('#cardBackThemeSelectorContainer img[data-is-predefined-back]').first().addClass('selected');
            }
            updatePreviewContainerDimensions();
            updateMainCardBackDisplay(); // Set initial card back for the main preview
            $(window).on('resize', updatePreviewContainerDimensions);
        });
    </script>
</body>

</html>